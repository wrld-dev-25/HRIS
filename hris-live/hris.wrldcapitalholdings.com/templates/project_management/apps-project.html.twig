{% extends 'partials/base.html.twig' %}

{% block title %}Projects{% endblock %}

{% block stylesheets %}
<style>
.loader {
    background-color: #ededed;
    height: 1.5rem;
    width: 100%;
    border-radius: 0.25rem;
}
div .loader {
    background-color: #ededed;
    background: linear-gradient(100deg,
    rgba(255, 255, 255, 0) 40%,
    rgba(255, 255, 255, .5) 50%,
    rgba(255, 255, 255, 0) 60%) #ededed;
    background-size: 200% 100%;
    background-position-x: 180%;
    animation: 1s loading ease-in-out infinite
}
@keyframes loading {
    to {
        background-position-x: -30%
    }
}
</style>
{% endblock %}

{% block content %}
    {% include 'project_management/worker-assignment-modal.html.twig' %}
    {{ component('breadcrumb', { pagetitle: 'Subdvisions', title: 'Subdivisions' }) }}

    <div class="grid grid-cols-12 2xl:grid-cols-12 gap-x-5">
        <div class="col-span-12 md:order-4 lg:col-span-6 2xl:col-span-3 card flex flex-col justify-center">
            <div class="card-body">
                <div class="grid grid-cols-12 items-between">
                    <div class="col-span-8 md:col-span-9">
                        <p class="text-slate-500 dark:text-slate-200 text-lg">Number of Subdivisions</p>
                    </div>
                    <div class="col-span-4 md:col-span-3">
                        <h5 class="text-green-500 text-2xl">{{ subdivisions|length }}</h5>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-span-12 md:order-4 lg:col-span-6 2xl:col-span-3 card flex flex-col justify-center">
            <div class="card-body">
                <div class="grid grid-cols-12">
                    <div class="col-span-8 md:col-span-9">
                        <p class="text-slate-500 dark:text-slate-200 text-lg">On-Going Projects</p>
                    </div>
                    <div class="col-span-4 md:col-span-3">
                        <h5 class="text-purple-500 text-2xl">{{ projects|length }}</h5>
                    </div>
                </div>
            </div>
        </div>
        <div class="add-projects col-span-12 md:order-4 lg:col-span-6 2xl:col-span-3 card flex flex-col justify-center">
            <div class="card-body">
                <div class="flex items-center">
                    <p class="text-slate-500 dark:text-slate-200 text-lg grow">Create New Project</p>
                    <div class="shrink-0">
                        <a href="{{ path('subwizard') }}" class="text-white btn bg-custom-500 border-custom-500 hover:text-white hover:bg-custom-600 hover:border-custom-600 focus:text-white focus:bg-custom-600 focus:border-custom-600 focus:ring focus:ring-custom-100 active:text-white active:bg-custom-600 active:border-custom-600 active:ring active:ring-custom-100 dark:ring-custom-400/20">
                            <i data-lucide="plus" class="inline-block size-4"></i>
                            <span class="align-middle">Add Project</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="add-projects col-span-12 md:order-4 lg:col-span-6 2xl:col-span-3 card flex flex-col justify-center">
            <div class="card-body">
                <div class="flex items-center">
                    <p class="text-slate-500 dark:text-slate-200 text-lg grow">Assign Worker/s</p>
                    <div class="shrink-0">
                        <a data-modal-target="assignWorkers" class="text-white btn bg-custom-500 border-custom-500 hover:text-white hover:bg-custom-600 hover:border-custom-600 focus:text-white focus:bg-custom-600 focus:border-custom-600 focus:ring focus:ring-custom-100 active:text-white active:bg-custom-600 active:border-custom-600 active:ring active:ring-custom-100 dark:ring-custom-400/20">
                            <i data-lucide="plus" class="inline-block size-4"></i>
                            <span class="align-middle">Assign</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 gap-x-5 lg:grid-cols-3 items-start">
        <div class="card">
            <div class="card-body">
                <h6 class="mb-4 text-15">Subdivision Details</h6>
                <div class="text-slate-500 indent-4" id="profileName">
                    <span class="text-slate-500 font-bold">Name: </span>{{ subProfile[0].name }}
                </div>
                <div class="grid grid-cols-12 gap-5">
                    <div class="col-span-8 text-slate-500 indent-4" id="profileLocation">
                        <span class="text-slate-500 font-bold">Location: </span>{{ subProfile[0].location }}
                    </div>
                    <div class="col-span-4 text-slate-500 indent-4" id="profileNumberPhases">
                        <span class="text-slate-500 font-bold">Phase: </span>{{ subProfile[0].total_phases }}
                    </div>
                </div>
                <div class="flex justify-center mt-2 mb-4">
                    <img class="rounded-t-md border" src="{{ asset('assets/images/support.png') }}" alt="Image">
                </div>
                <div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="ltr:text-left rtl:text-right">
                                <tr>
                                    <th class="px-3.5 py-2.5 font-semibold border-b border-slate-200 dark:border-zink-500 text-center">Phase</th>
                                    <th class="px-3.5 py-2.5 font-semibold border-b border-slate-200 dark:border-zink-500 text-center">Number of Blocks</th>
                                    <th class="px-3.5 py-2.5 font-semibold border-b border-slate-200 dark:border-zink-500 text-center">Number of Lots</th>
                                </tr>
                            </thead>
                            <tbody id="profileDetailsBlock">
                            {% for sub in subProfile %}
                                {% if sub.phases is empty %}
                                    <tr>
                                        <td class="px-3.5 py-2.5 border-y border-slate-200 dark:border-zink-500 text-center col-span-3" id="profilePhases">
                                            No Available Phases
                                        </td>
                                    </tr>
                                {% else %}
                                    {% for phase in sub.phases %}
                                        <tr>
                                            <td class="px-3.5 py-2.5 border-y border-slate-200 dark:border-zink-500 text-center" id="profilePhases">{{ phase.name }}</td>
                                            <td class="px-3.5 py-2.5 border-y border-slate-200 dark:border-zink-500 text-center" id="profileBlocks">{{ phase.totalBlocks }}</td>
                                            <td class="px-3.5 py-2.5 border-y border-slate-200 dark:border-zink-500 text-center" id="profileLots">{{ phase.totalLots }}</td>
                                        </tr>
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2">
            <div class="grid grid-cols-1 gap-x-5 xl:grid-cols-12">
                <div class="xl:col-span-12">
                    {% set active = app.request.get('t') %}
                    {% if (active is not empty and active == "pl") %}
                        <div class="card border-2 rounded-md border-custom-500" id="onGoingProjectsTable">
                    {% else %}
                        <div class="card" id="onGoingProjectsTable">
                    {% endif %}
                        <div class="card-body">
                            <div class="flex items-center">
                                <h6 class="text-15 grow">On-Going Projects List</h6>
                            </div>
                        </div>
                        <div class="!py-3.5 card-body border-y border-dashed border-slate-200 dark:border-zink-500">
                            <form action="#!">
                                <div class="grid grid-cols-1 gap-5 xl:grid-cols-12">
                                    <div class="relative xl:col-span-4">
                                        <input type="text" class="ltr:pl-8 rtl:pr-8 search form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200" placeholder="Search for code, name, subdivision etc..." autocomplete="off">
                                        <i data-lucide="search" class="inline-block size-4 absolute ltr:left-2.5 rtl:right-2.5 top-2.5 text-slate-500 dark:text-zink-200 fill-slate-100 dark:fill-zink-600"></i>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="card-body">
                            <div class="-mx-5 -mb-5 overflow-x-auto">
                                <table class="w-full border-separate table-custom border-spacing-y-1 whitespace-nowrap">
                                    <thead class="text-left">
                                        <tr class="relative rounded-md bg-slate-100 dark:bg-zink-600 after:absolute ltr:after:border-l-2 rtl:after:border-r-2 ltr:after:left-0 rtl:after:right-0 after:top-0 after:bottom-0 after:border-transparent [&.active]:after:border-custom-500 [&.active]:bg-slate-100 dark:[&.active]:bg-zink-600">
                                            <th class="px-3.5 py-2.5 first:pl-5 last:pr-5 font-semibold sort" data-sort="code">Code</th>
                                            <th class="px-3.5 py-2.5 first:pl-5 last:pr-5 font-semibold sort" data-sort="name">Name</th>
                                            <th class="px-3.5 py-2.5 first:pl-5 last:pr-5 font-semibold sort" data-sort="subdivision">Subdivision</th>
                                            <th class="px-3.5 py-2.5 first:pl-5 last:pr-5 font-semibold sort" data-sort="phase">Phase</th>
                                            <th class="px-3.5 py-2.5 first:pl-5 last:pr-5 font-semibold sort" data-sort="description">Description</th>
                                            <th class="px-3.5 py-2.5 first:pl-5 last:pr-5 font-semibold sort" data-sort="location">Location</th>
                                        </tr>
                                    </thead>
                                    <tbody class="list">
                                        {% for projectItem in projects %}
                                            {% set subdivision = projectItem.subdivision is defined ? projectItem.subdivision : null %}
                                            <tr class="relative rounded-md after:absolute ltr:after:border-l-2 rtl:after:border-r-2 ltr:after:left-0 rtl:after:right-0 after:top-0 after:bottom-0 after:border-transparent [&.active]:after:border-custom-500 [&.active]:bg-slate-100 dark:[&.active]:bg-zink-600">
                                                <td class="px-3.5 py-2.5 first:pl-5 last:pr-5">
                                                    <div class="flex items-center gap-2">
                                                        <div class="grow">
                                                            <h6 class="mb-1">
                                                                <a style="cursor: pointer" data-modal-target="selectedProject" data-project-id="{{ projectItem.id }}" class="text-custom-500 code">
                                                                    {{ projectItem.code|default('') }}
                                                                </a>
                                                            </h6>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-3.5 py-2.5 first:pl-5 last:pr-5 name">
                                                    {{ projectItem.name|default('') }}
                                                </td>
                                                <td class="px-3.5 py-2.5 first:pl-5 last:pr-5 subdivision">
                                                    {{ subdivision.name|default('') }}
                                                </td>
                                                <td class="px-3.5 py-2.5 first:pl-5 last:pr-5 phase">
                                                    {% if subdivision is not null and subdivision.phase is defined and subdivision.phase|length > 0 %}
                                                        {{ subdivision.phase[0].name|default('') }}
                                                    {% else %}
                                                        {# leave empty or show a placeholder #}
                                                    {% endif %}
                                                </td>
                                                <td class="px-3.5 py-2.5 first:pl-5 last:pr-5 subdivision">
                                                    {{ projectItem.description|default('No description available') }}
                                                </td>
                                                <td class="px-3.5 py-2.5 first:pl-5 last:pr-5 location">
                                                    {% if projectItem.category is defined and projectItem.category is not empty
                                                        and projectItem.category[0].blocks is not null
                                                        and projectItem.category[0].lots is not null %}
                                                        {{ projectItem.category[0].blocks.name }} / {{ projectItem.category[0].lots.name }}
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                <div class="noresult-onGoingProject" style="display: none">
                                    <div class="py-6 text-center">
                                        <i data-lucide="search" class="size-6 mx-auto text-sky-500 fill-sky-100 dark:fill-sky-500/20"></i>
                                        <h5 class="mt-2">Sorry! No Result Found</h5>
                                        <p class="mb-0 text-slate-500 dark:text-zink-200">We did not find any users for your search.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col items-center gap-4 px-4 mt-8 md:flex-row" id="pagination-element">
                                <div class="grow">
                                    <p class="text-slate-500 dark:text-zink-200">
                                        Showing <b class="showing">10</b> of <b class="total-records">{{ projects|length }}</b> Results
                                    </p>
                                </div>
                                <div class="col-sm-auto mt-sm-0">
                                    <div class="flex gap-2 pagination-wrap justify-content-center">
                                        <a class="inline-flex items-center justify-center bg-white dark:bg-zink-700 h-8 px-3 transition-all duration-150 ease-linear border rounded border-slate-200 dark:border-zink-500 text-slate-500 dark:text-zink-200 hover:text-custom-500 dark:hover:text-custom-500 hover:bg-custom-50 dark:hover:bg-custom-500/10 focus:bg-custom-50 dark:focus:bg-custom-500/10 focus:text-custom-500 dark:focus:text-custom-500 page-item pagination-prev" href="javascript:void(0)">
                                            <i class="size-4 mr-1 rtl:rotate-180" data-lucide="chevron-left"></i> Prev
                                        </a>
                                        <ul class="flex flex-wrap items-center gap-2 pagination listjs-pagination"></ul>
                                        <a class="inline-flex items-center justify-center bg-white dark:bg-zink-700 h-8 px-3 transition-all duration-150 ease-linear border rounded border-slate-200 dark:border-zink-500 text-slate-500 dark:text-zink-200 hover:text-custom-500 dark:hover:text-custom-500 hover:bg-custom-50 dark:hover:bg-custom-500/10 focus:bg-custom-50 dark:focus:bg-custom-500/10 focus:text-custom-500 dark:focus:text-custom-500 page-item pagination-next" href="javascript:void(0)">
                                            Next <i class="size-4 ml-1 rtl:rotate-180" data-lucide="chevron-right"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div><!--end card-->
                </div><!--end col-->
            </div><!--end grid-->

            <div class="grid grid-cols-1 gap-x-5 xl:grid-cols-12">
                <div class="xl:col-span-12">
                    <div class="card view-subdivision" id="subdivisionTable">
                        <div class="card-body">
                            <div class="flex items-center">
                                <h6 class="text-15 grow">Subdivisions List</h6>
                            </div>
                        </div>
                        <div class="!py-3.5 card-body border-y border-dashed border-slate-200 dark:border-zink-500">
                            <form action="#!">
                                <div class="grid grid-cols-1 gap-5 xl:grid-cols-12">
                                    <div class="relative xl:col-span-4">
                                        <input type="text" class="ltr:pl-8 rtl:pr-8 search form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200" placeholder="Search for code, name, location etc..." autocomplete="off">
                                        <i data-lucide="search" class="inline-block size-4 absolute ltr:left-2.5 rtl:right-2.5 top-2.5 text-slate-500 dark:text-zink-200 fill-slate-100 dark:fill-zink-600"></i>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="card-body">
                            <div class="-mx-5 -mb-5 overflow-x-auto">
                                <table class="w-full border-separate table-custom border-spacing-y-1 whitespace-nowrap" id="subTable">
                                    <thead class="text-left">
                                        <tr class="relative rounded-md bg-slate-100 dark:bg-zink-600 after:absolute ltr:after:border-l-2 rtl:after:border-r-2 ltr:after:left-0 rtl:after:right-0 after:top-0 after:bottom-0 after:border-transparent [&.active]:after:border-custom-500 [&.active]:bg-slate-100 dark:[&.active]:bg-zink-600">
                                            <th class="px-3.5 py-2.5 first:pl-5 last:pr-5 font-semibold sort" data-sort="code">Code</th>
                                            <th class="px-3.5 py-2.5 first:pl-5 last:pr-5 font-semibold sort" data-sort="name">Name</th>
                                            <th class="px-3.5 py-2.5 first:pl-5 last:pr-5 font-semibold sort" data-sort="location">Location</th>
                                            <th class="px-3.5 py-2.5 first:pl-5 last:pr-5 font-semibold sort" data-sort="phaseNumber">No. of Phases</th>
                                            <th class="px-3.5 py-2.5 first:pl-5 last:pr-5 font-semibold sort" data-sort="lot">Total No. of Lots</th>
                                            <th class="px-3.5 py-2.5 first:pl-5 last:pr-5 font-semibold">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="list">
                                        {% for key, subdivisionItem in subdivisions %}
                                            <tr class="relative rounded-md after:absolute ltr:after:border-l-2 rtl:after:border-r-2 ltr:after:left-0 rtl:after:right-0 after:top-0 after:bottom-0 after:border-transparent [&.active]:after:border-custom-500 [&.active]:bg-slate-100 dark:[&.active]:bg-zink-600">
                                                <td class="hidden id" data-key="id" data-value="{{ subdivisionItem.id }}"></td>
                                                <td class="hidden" data-key="code" data-value="{{ subdivisionItem.subdivisionCode }}"></td>
                                                <td class="hidden description" data-key="description" data-value="{{ subdivisionItem.description }}"></td>
                                                <td class="px-3.5 py-2.5 first:pl-5 last:pr-5 cursor-pointer code" data-key="subdivisionCode" data-value="{{ subdivisionItem.subdivisionCode }}">
                                                    <div class="flex items-center gap-2">
                                                        <div class="grow">
                                                            <h6 class="mb-1">
                                                                <a href="javascript:void(0)" class="text-custom-500 code">
                                                                    {{ subdivisionItem.subdivisionCode }}
                                                                </a>
                                                            </h6>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-3.5 py-2.5 first:pl-5 last:pr-5 name" data-key="name" data-value="{{ subdivisionItem.name }}">{{ subdivisionItem.name }}</td>
                                                <td class="px-3.5 py-2.5 first:pl-5 last:pr-5 location" data-key="location" data-value="{{ subdivisionItem.location }}">{{ subdivisionItem.location }}</td>
                                                <td class="px-3.5 py-2.5 first:pl-5 last:pr-5 phase" data-key="total_phases" data-value="{{ subdivisionItem.total_phases }}">{{ subdivisionItem.total_phases }}</td>
                                                <td class="px-3.5 py-2.5 first:pl-5 last:pr-5 lot" data-key="total_lots" data-value="{{ subdivisionItem.total_lots }}">{{ subdivisionItem.total_lots }}</td>
                                                <td class="px-3.5 py-2.5 first:pl-5 last:pr-5">
                                                    <div class="action-subdivision relative dropdown">
                                                        <button class="flex items-center justify-center size-[30px] dropdown-toggle p-0 text-slate-500 btn bg-slate-100 hover:text-white hover:bg-slate-600 focus:text-white focus:bg-slate-600 focus:ring focus:ring-slate-100 active:text-white active:bg-slate-600 active:ring active:ring-slate-100 dark:bg-slate-500/20 dark:text-slate-400 dark:hover:bg-slate-500 dark:hover:text-white dark:focus:bg-slate-500 dark:focus:text-white dark:active:bg-slate-500 dark:active:text-white dark:ring-slate-400/20" id="usersAction1" data-bs-toggle="dropdown">
                                                            <i data-lucide="more-horizontal" class="size-3"></i>
                                                        </button>
                                                        <ul class="absolute z-50 hidden py-2 mt-1 ltr:text-left rtl:text-right list-none bg-white rounded-md shadow-md dropdown-menu min-w-[10rem] dark:bg-zink-600" aria-labelledby="usersAction1">
                                                            <li>
                                                                <a data-modal-target="editSubdivisionModal" id="editSubdivision" class="edit-subdivision block px-4 py-1.5 text-base transition-all duration-200 ease-linear text-slate-600 dropdown-item hover:bg-slate-100 hover:text-slate-500 focus:bg-slate-100 focus:text-slate-500 dark:text-zink-100 dark:hover:bg-zink-500 dark:hover:text-zink-200 dark:focus:bg-zink-500 dark:focus:text-zink-200" href="#!">
                                                                    <i data-lucide="file-edit" class="inline-block size-3 ltr:mr-1 rtl:ml-1"></i>
                                                                    <span class="align-middle">Edit</span>
                                                                </a>
                                                            </li>
                                                            <li>
                                                                <a data-modal-target="deleteSubdivisionModal" id="deleteSubdivision" class="delete-subdivision block px-4 py-1.5 text-base transition-all duration-200 ease-linear text-slate-600 dropdown-item hover:bg-slate-100 hover:text-slate-500 focus:bg-slate-100 focus:text-slate-500 dark:text-zink-100 dark:hover:bg-zink-500 dark:hover:text-zink-200 dark:focus:bg-zink-500 dark:focus:text-zink-200" href="#!">
                                                                    <i data-lucide="trash-2" class="inline-block size-3 ltr:mr-1 rtl:ml-1"></i>
                                                                    <span class="align-middle">Delete</span>
                                                                </a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                <div class="noresult" style="display: none">
                                    <div class="py-6 text-center">
                                        <i data-lucide="search" class="size-6 mx-auto text-sky-500 fill-sky-100 dark:fill-sky-500/20"></i>
                                        <h5 class="mt-2">Sorry! No Result Found</h5>
                                        <p class="mb-0 text-slate-500 dark:text-zink-200">We've searched more than 199+ users. We did not find any users for your search.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div><!--end card-->
                </div><!--end col-->
            </div><!--end grid-->
        </div>
    </div>

    {# Edit Subdivision Modal #}
    <div id="editSubdivisionModal" modal-center class="fixed flex flex-col hidden transition-all duration-300 ease-in-out left-2/4 z-drawer -translate-x-2/4 -translate-y-2/4 show ">
        <div class="w-screen md:w-[30rem] bg-white shadow rounded-md dark:bg-zink-600">
            <div class="flex items-center justify-between p-4 border-b dark:border-zink-300/20">
                <h5 class="text-16">Edit Subdivision</h5>
                <button data-modal-close="editSubdivisionModal" class="transition-all duration-200 ease-linear text-slate-400 hover:text-red-500">
                    <i data-lucide="x" class="size-5"></i>
                </button>
            </div>
            <div class="max-h-[calc(theme('height.screen')_-_180px)] p-4 overflow-y-auto">
                <form action="{{ path('project_update_subdivision_form') }}" method="post">
                    <input type="hidden" id="id" name="subdivision_id" value="">
                    <div class="mb-3">
                        <label for="code" class="inline-block mb-2 text-base font-medium">Subdivision code</label>
                        <input type="text" id="code" name="code" class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200" placeholder="Enter code" value="" required>
                    </div>
                    <div class="mb-3">
                        <label for="name" class="inline-block mb-2 text-base font-medium">Subdivsion Name</label>
                        <input type="text" id="name" name="name" class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200" placeholder="Enter subdivision name" value="" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="inline-block mb-2 text-base font-medium">Description</label>
                        <input type="text" id="description" name="description" class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200" placeholder="Enter subdivision description" value="" required>
                    </div>
                    <div class="mb-3">
                        <label for="location" class="inline-block mb-2 text-base font-medium">Location</label>
                        <input type="text" id="location" name="location" class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200" placeholder="Enter subdivision location" value="" required>
                    </div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button type="reset" data-modal-close="editSubdivisionModal" class="text-red-500 transition-all duration-200 ease-linear bg-white border-white btn hover:text-red-600 focus:text-red-600 active:text-red-600 dark:bg-zink-500 dark:border-zink-500">Cancel</button>
                        <button type="submit" class="text-white transition-all duration-200 ease-linear btn bg-custom-500 border-custom-500 hover:text-white hover:bg-custom-600 hover:border-custom-600 focus:text-white focus:bg-custom-600 focus:border-custom-600 focus:ring focus:ring-custom-100 active:text-white active:bg-custom-600 active:border-custom-600 active:ring active:ring-custom-100 dark:ring-custom-400/20">Update</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {# Delete Subdivision Modal #}
    <div id="deleteSubdivisionModal" modal-center class="fixed flex flex-col hidden transition-all duration-300 ease-in-out left-2/4 z-drawer -translate-x-2/4 -translate-y-2/4 show">
        <div class="w-screen md:w-[25rem] bg-white shadow rounded-md dark:bg-zink-600">
            <div class="max-h-[calc(theme('height.screen')_-_180px)] overflow-y-auto px-6 py-8">
                <div class="float-right">
                    <button data-modal-close="deleteSubdivisionModal" class="transition-all duration-200 ease-linear text-slate-500 hover:text-red-500">
                        <i data-lucide="x" class="size-5"></i>
                    </button>
                </div>
                <img src="{{ asset('assets/images/delete.png') }}" alt="" class="block h-12 mx-auto">
                <div class="mt-5 text-center">
                    <h5 class="mb-1">Are you sure?</h5>
                    <p class="text-slate-500 dark:text-zink-200">Are you certain you want to delete this record?</p>
                    <div class="flex justify-center gap-2 mt-6">
                        <form action="{{ path('project_delete_subdivision_form') }}" method="post">
                            <input type="hidden" name="subdivision_id" id="delId" value="">
                            <button type="reset" data-modal-close="deleteSubdivisionModal" class="bg-white text-slate-500 btn hover:text-slate-500 hover:bg-slate-100 focus:text-slate-500 focus:bg-slate-100 active:text-slate-500 active:bg-slate-100 dark:bg-zink-600 dark:hover:bg-slate-500/10 dark:focus:bg-slate-500/10 dark:active:bg-slate-500/10">Cancel</button>
                            <button type="submit" class="text-white bg-red-500 border-red-500 btn hover:text-white hover:bg-red-600 hover:border-red-600 focus:text-white focus:bg-red-600 focus:border-red-600 focus:ring focus:ring-red-100 active:text-white active:bg-red-600 active:border-red-600 active:ring active:ring-red-100 dark:ring-custom-400/20">Yes, Delete It!</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Add Project Modal #}
    <div id="addProjectModal" modal-center class="fixed flex flex-col hidden transition-all duration-300 ease-in-out left-2/4 z-drawer -translate-x-2/4 -translate-y-2/4 show ">
        <div class="w-screen md:w-[30rem] bg-white shadow rounded-md dark:bg-zink-600">
            <div class="flex items-center justify-between p-4 border-b dark:border-zink-300/20">
                <h5 class="text-16">Add Project</h5>
                <button data-modal-close="addProjectModal" class="transition-all duration-200 ease-linear text-slate-400 hover:text-red-500">
                    <i data-lucide="x" class="size-5"></i>
                </button>
            </div>
            <div class="max-h-[calc(theme('height.screen')_-_180px)] p-4 overflow-y-auto">
                <form action="{{ path('submit_project_form') }}" method="post">
                    <div class="mb-3">
                        <label for="subdivision" class="inline-block mb-2 text-base font-medium">Subdivsion Name</label>
                        <select class="form-select border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200" data-choices id="choices-single-default" name="subdivision">
                            {% for subdivisionItem in subdivisions %}
                                <option value="{{ subdivisionItem.id }}">{{ subdivisionItem.subdivisionCode }} - {{ subdivisionItem.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="code" class="inline-block mb-2 text-base font-medium">Project Code</label>
                        <input type="text" id="code" name="code" class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200" placeholder="Enter code" value="" required>
                    </div>
                    <div class="mb-3">
                        <label for="name" class="inline-block mb-2 text-base font-medium">Project Name</label>
                        <input type="text" id="name" name="name" class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200" placeholder="Enter name" value="" required>
                    </div>
                    <div class="mb-3">
                        <label for="desc" class="inline-block mb-2 text-base font-medium">Project Description</label>
                        <input type="text" id="desc" name="desc" class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 disabled:bg-slate-100 dark:disabled:bg-zink-600 disabled:border-slate-300 dark:disabled:border-zink-500 dark:disabled:text-zink-200 disabled:text-slate-500 dark:text-zink-100 dark:bg-zink-700 dark:focus:border-custom-800 placeholder:text-slate-400 dark:placeholder:text-zink-200" placeholder="Enter description" value="" required>
                    </div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button type="button" data-modal-close="addProjectModal" class="text-red-500 transition-all duration-200 ease-linear bg-white border-white btn hover:text-red-600 focus:text-red-600 active:text-red-600 dark:bg-zink-500 dark:border-zink-500">Cancel</button>
                        <button type="submit" class="text-white transition-all duration-200 ease-linear btn bg-custom-500 border-custom-500 hover:text-white hover:bg-custom-600 hover:border-custom-600 focus:text-white focus:bg-custom-600 focus:border-custom-600 focus:ring focus:ring-custom-100 active:text-white active:bg-custom-600 active:border-custom-600 active:ring active:ring-custom-100 dark:ring-custom-400/20">Add Project</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% for flash_message in app.flashes('status') %}
        <div class="hidden" id="status" data-status="{{ flash_message }}"></div>
    {% endfor %}
    {% for flash_message in app.flashes('info') %}
        <div class="hidden" id="info" data-status="{{ flash_message }}"></div>
    {% endfor %}
{% endblock %}

{% block javascripts %}
<!-- App js -->
<script src="{{ asset('assets/js/app.js') }}"></script>
<script src="{{ asset('assets/libs/list.js/list.min.js') }}"></script>
<script src="{{ asset('assets/libs/list.pagination.js/list.pagination.min.js') }}"></script>
<script src="{{ asset('assets/js/pages/apps-list-init.js') }}"></script>

{{ javascriptSnippet|default('')|raw }}

<script>
$(document).ready(function () {
    const profileDetailsBlock = $('#profileDetailsBlock');
    const profileName = $('#profileName');
    const profileLocation = $('#profileLocation');
    const profileNumberPhases = $('#profileNumberPhases');

    $('#subTable').on('click', '.code', function () {
        const $tr = $(this).closest('tr');
        let subId = null;

        $tr.children("td").each(function () {
            const key = $(this).data('key');
            const value = $(this).data('value');
            if (key === 'code') {
                subId = value;
            }
        });

        if (subId) {
            filter_task(subId);
        }
    });

    function filter_task(subId){
        $.ajax({
            url: '{{ path('select_subdivision_profile') }}',
            type: 'POST',
            data: {
                subdivisionCode: subId
            },
            beforeSend: function() {
                profileName.html('<div class="loader mb-2"></div>');
                profileLocation.html('<div class="loader"></div>');
                profileNumberPhases.html('<div class="loader"></div>');

                profileDetailsBlock.children("tr").each(function () {
                    $(this).children("td").each(function () {
                        $(this).html('<div class="loader"></div>');
                    });
                });
            },
            success: function(data) {
                const sub = data.subProfile.subdivisions[0] ?? null;

                profileDetailsBlock.html('');

                if (!sub) {
                    profileName.html('<span class="text-slate-500 font-bold">Name: </span>—');
                    profileLocation.html('<span class="text-slate-500 font-bold">Location: </span>—');
                    profileNumberPhases.html('<span class="text-slate-500 font-bold">Phases: </span>0');
                    profileDetailsBlock.html('<tr><td class="px-3.5 py-2.5 border-y border-slate-200 dark:border-zink-500 text-center col-span-3">No Available Phases</td></tr>');
                    return;
                }

                const subName = sub.name;
                const subLocation = sub.location;
                const total_phases = sub.total_phases;
                const phases = sub.phases;

                profileName.html('<span class="text-slate-500 font-bold">Name: </span>' + subName);
                profileLocation.html('<span class="text-slate-500 font-bold">Location: </span>' + subLocation);
                profileNumberPhases.html('<span class="text-slate-500 font-bold">Phases: </span>' + total_phases);

                let newHtml = '';

                if (!phases || phases.length === 0) {
                    newHtml += '<tr>';
                    newHtml += '<td class="px-3.5 py-2.5 border-y border-slate-200 dark:border-zink-500 text-center col-span-3">No Available Phases</td>';
                    newHtml += '</tr>';
                } else {
                    phases.forEach(function(val) {
                        newHtml += '<tr>';
                        newHtml += '<td class="px-3.5 py-2.5 border-y border-slate-200 dark:border-zink-500 text-center">' + val['name'] + '</td>';
                        newHtml += '<td class="px-3.5 py-2.5 border-y border-slate-200 dark:border-zink-500 text-center">' + val['totalBlocks'] + '</td>';
                        newHtml += '<td class="px-3.5 py-2.5 border-y border-slate-200 dark:border-zink-500 text-center">' + val['totalLots'] + '</td>';
                        newHtml += '</tr>';
                    });
                }

                profileDetailsBlock.html(newHtml);
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                alert('There was an error processing your request.');
            }
        });
    }

    // Edit Modal Data handling
    $('#subTable').on('click', '#editSubdivision', function () {
        const $row = $(this).closest('tr');
        const id = $row.find('.id').data('value');
        const code = $row.find('.code').data('value');
        const name = $row.find('.name').data('value');
        const description = $row.find('.description').data('value');
        const location = $row.find('.location').data('value');

        $('#editSubdivisionModal #id').val(id);
        $('#editSubdivisionModal #code').val(code);
        $('#editSubdivisionModal #name').val(name);
        $('#editSubdivisionModal #description').val(description);
        $('#editSubdivisionModal #location').val(location);
    });

    // Delete Modal Data handling
    $('#subTable').on('click', '#deleteSubdivision', function () {
        const $row = $(this).closest('tr');
        const id = $row.find('.id').data('value');
        $('#deleteSubdivisionModal #delId').val(id);
    });

    // Toaster message
    const status = $('#status');
    const info = $('#info').data('status');
    if (status.length) {
        if (status.data('status') === 'success') {
            const message = 'Subdivision ' + info + ' successfully';
            const color = 'bg-green-500';
            showToast(message, color);
        } else {
            const message = 'Subdivision not ' + info + ', something went wrong';
            const color = 'bg-red-500';
            showToast(message, color);
        }
    }

    function addCollapsibleSection(projectName, projectId) {
        const collapsibleTemplate = `
            <div data-project-id="${projectId}" class="collapsible col-span-12 card collapsible-${projectId}">
                <div class="card-body flex justify-between text-white collapsible-header group/item rounded-md bg-custom-500 border-custom-500 hover:text-white hover:bg-custom-600 hover:border-custom-600 focus:text-white focus:bg-custom-600 focus:border-custom-600 focus:ring focus:ring-custom-100 active:text-white active:bg-custom-600 active:border-custom-600 active:ring active:ring-custom-100 dark:ring-custom-400/20 show">
                    <h6 class="text-15 text-white">${projectName}</h6>
                    <div class="ltr:ml-2 rtl:mr-2 shrink-0">
                        <i data-lucide="chevron-down" class="hidden size-4 group-[.show]/item:inline-block"></i>
                        <i data-lucide="chevron-up" class="inline-block size-4 group-[.show]/item:hidden"></i>
                    </div>
                </div>
                <div class="mt-2 mb-0 collapsible-content card workers-card"></div>
            </div>
        `;
        $('.dynamic-projects').append(collapsibleTemplate);
    }

    // Listen for changes in the projectSelect dropdown
    $('#projectSelect').on('change', function () {
        const selectedProjects = $(this).find('option:selected');
        const selectedProjectIds = selectedProjects.map(function () {
            return $(this).val();
        }).get();

        // Remove collapsibles that are no longer selected
        $('.collapsible').each(function () {
            const match = $(this).attr('class').match(/collapsible-(\d+)/);
            if (match) {
                const collapsibleId = match[1];
                if (!selectedProjectIds.includes(collapsibleId)) {
                    $(this).remove();
                }
            }
        });

        selectedProjects.each(function () {
            const projectName = $(this).text();
            const projectId = $(this).val();

            if ($(`.collapsible-${projectId}`).length === 0) {
                addCollapsibleSection(projectName, projectId);

                const selectedWorkers = $('#workerSelect').find('option:selected');
                selectedWorkers.each(function () {
                    const workerName = $(this).text();
                    const workerId = $(this).val();

                    $(`.collapsible-${projectId} .workers-card`).append(createWorkerCard(workerName, workerId, projectId, 'add'));
                });

                if (window.lucide) {
                    lucide.createIcons();
                }
            }
        });
    });

    $('#workerSelect, #projectWorkers').on('change', function () {
        const selectedWorkers = $(this).find('option:selected');
        const selectedWorkerIds = selectedWorkers.map(function () {
            return $(this).val();
        }).get();

        $('.collapsible').each(function () {
            const collapsible = $(this);
            const projectId = collapsible.data('project-id');

            collapsible.find('.worker-card').each(function () {
                const workerCardId = $(this).data('worker-id').toString();
                if (!selectedWorkerIds.includes(workerCardId)) {
                    $(this).remove();
                }
            });

            selectedWorkers.each(function () {
                const workerName = $(this).text();
                const workerId = $(this).val();

                if (collapsible.find(`.worker-card[data-worker-id="${workerId}"]`).length === 0) {
                    collapsible.find('.workers-card').append(createWorkerCard(workerName, workerId, projectId, 'add'));
                    if (window.lucide) {
                        lucide.createIcons();
                    }
                }
            });
        });
    });

    function createWorkerCard(workerName, workerId, projectId, action) {
        return `
            <div class="card-body worker-card" data-worker-id="${workerId}">
                <div class="grid gap-4 grid-cols-6 flex items-start">
                    <span class="inline-block mb-2 text-base font-medium">${workerName}</span>
                    <div class="grid gap-x-4 grid-cols-12 col-span-12 md:col-span-12 border rounded-md border-dashed p-5">
                        <div class="grid gap-4 grid-cols-12 col-span-12 mb-2">
                            <div class="col-span-4">
                                <span class="inline-block mb-2 text-base font-medium">Task</span>
                            </div>
                            <div class="col-span-4">
                                <span class="inline-block mb-2 text-base font-medium">Date</span>
                            </div>
                            <div class="col-span-4">
                                <span class="inline-block mb-2 text-base font-medium">Assigned Time</span>
                            </div>
                        </div>
                        <input type="hidden" name="assignments[projects][${projectId}][workers][${workerId}][workerId]" value="${workerId}">
                        <input type="hidden" name="assignments[projects][${projectId}][workers][${workerId}][projectId]" value="${projectId}">
                        <input type="hidden" name="assignments[projects][${projectId}][workers][${workerId}][action]" value="${action}">
                        <div class="grid gap-4 grid-cols-12 col-span-12 mb-2 dependents-wrapper"></div>
                        <div class="grid gap-4 grid-cols-12 col-span-12 mb-2 add-dependent-wrapper">
                            <div class="col-span-12 flex justify-end items-center">
                                <i data-lucide="plus" class="size-4 text-custom-500"></i>
                                <a href="javascript:void(0)" class="text-custom-500 addTask underline underline-offset-5" data-worker-id="${workerId}" data-project-id="${projectId}"> Add Task</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function createTaskContainer(workerId, projectId, taskIndex) {
        return `
            <div class="grid gap-4 grid-cols-12 col-span-12 dependents-container">
                <div class="col-span-12 flex justify-end toggle-hidden-dependent">
                    <button type="button" class="flex items-center justify-center transition-all duration-200 ease-linear rounded size-8 text-red-500 bg-red-100 hover:bg-red-200 dark:bg-red-500/20 dark:hover:bg-red-500/30 delDependent" data-worker-id="${workerId}">
                        <i data-lucide="trash" class="size-4"></i>
                    </button>
                </div>
                <input type="hidden" name="assignments[projects][${projectId}][workers][${workerId}][tasks][${taskIndex}][status]" value="add">
                <input type="hidden" name="assignments[projects][${projectId}][workers][${workerId}][tasks][${taskIndex}][task_id]" value="">
                <div class="col-span-4">
                    <input type="text" name="assignments[projects][${projectId}][workers][${workerId}][tasks][${taskIndex}][task]" class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 placeholder:text-slate-400 dark:placeholder:text-zink-200" placeholder="Enter Task Name">
                </div>
                <div class="col-span-4">
                    <input type="text" name="assignments[projects][${projectId}][workers][${workerId}][tasks][${taskIndex}][date]" class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 placeholder:text-slate-400 dark:placeholder:text-zink-200" placeholder="Select date" data-provider="flatpickr" data-date-format="d M, Y" data-altFormat="d M, Y">
                </div>
                <div class="col-span-4">
                    <input type="text" name="assignments[projects][${projectId}][workers][${workerId}][tasks][${taskIndex}][time]" class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 placeholder:text-slate-400 dark:placeholder:text-zink-200" placeholder="Enter Time (Hours:Minutes)" data-provider="timepickr" data-time-hrs="true">
                </div>
            </div>
        `;
    }

    $(document).on('click', '.addTask', function (e) {
        e.preventDefault();

        const workerId = $(this).data('worker-id');
        const projectId = $(this).data('project-id');

        const dependentsWrapper = $(`.collapsible-${projectId} .worker-card[data-worker-id="${workerId}"] .dependents-wrapper`);
        const taskIndex = dependentsWrapper.children('.dependents-container').length;

        dependentsWrapper.append(createTaskContainer(workerId, projectId, taskIndex));

        if (window.lucide) {
            lucide.createIcons();
        }

        if (typeof reinitializeFlatpickr === 'function') {
            reinitializeFlatpickr();
        }
        if (typeof reinitializeTimepickr === 'function') {
            reinitializeTimepickr();
        }
    });

    $(document).on('click', '.delDependent', function (e) {
        e.preventDefault();
        $(this).closest('.dependents-container').remove();
    });

    async function loadData() {
        try {
            const projectListResponse = await apiCall('GET', 'api/project/summary', []);
            const employeeListResponse = await apiCall('GET', 'api/employee201/assignable', []);

            const projectList = projectListResponse.projects || [];
            const employeeList = Object.values(employeeListResponse.employees || {});

            const projectSelect = $('#projectSelect');
            const workerSelect = $('#workerSelect');

            projectSelect.empty();
            workerSelect.empty();

            projectList.forEach(project => {
                const option = $('<option></option>').val(project.id).text(project.code);
                projectSelect.append(option);
            });

            employeeList.forEach(employee => {
                const fullName = `${employee.first_name} ${employee.middle_name || ''} ${employee.last_name}`.trim();
                const option = $('<option></option>').val(employee.id).text(fullName);
                workerSelect.append(option);
            });

            if (window.Choices) {
                if (projectSelect.data('choices')) {
                    projectSelect.data('choices').destroy();
                    projectSelect.removeData('choices');
                }
                if (workerSelect.data('choices')) {
                    workerSelect.data('choices').destroy();
                    workerSelect.removeData('choices');
                }

                const projectChoices = new Choices('#projectSelect', {
                    searchEnabled: true,
                    removeItemButton: true,
                    allowHTML: true,
                    multiple: true
                });
                const workerChoices = new Choices('#workerSelect', {
                    searchEnabled: true,
                    removeItemButton: true,
                    allowHTML: true,
                    multiple: true
                });

                projectSelect.data('choices', projectChoices);
                workerSelect.data('choices', workerChoices);

                $('.assign-projects-div').show();
                $('.assign-projects-spinner').hide();
            }
        } catch (e) {
            console.error('Error loading data:', e);
            $('.assign-projects-spinner').hide();
        }
    }

    loadData();

    $('#create-form').on('submit', function (e) {
        e.preventDefault();

        const formData = $(this).serialize();

        $.ajax({
            url: '{{ path("assign_workers_to_projects") }}',
            type: 'POST',
            data: formData,
            beforeSend: function () {
                $('#addNew').prop('disabled', true).text('Submitting...');
            },
            success: function (response) {
                if (response.status === 'success') {
                    showToast(response.message, 'bg-green-500');
                } else {
                    showToast('Something went wrong!', 'bg-red-500');
                }
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
                showToast('Failed to submit data. Please try again.', 'bg-red-500');
            },
            complete: function () {
                $('#addNew').prop('disabled', false).text('Save');
            }
        });
    });

    $('#selectedProjectForm').on('submit', function (e) {
        e.preventDefault();
    });
});
</script>

<script>
$(document).on('click', '[data-modal-target="selectedProject"]', function () {
    const projectId = $(this).data('project-id');

    $('#selectedProject').removeClass('hidden').addClass('flex');

    $.ajax({
        url: '{{ path("app_emp_project_json", { id: "PROJECT_ID" }) }}'.replace('PROJECT_ID', projectId),
        type: 'GET',
        beforeSend: function () {
            $('#selectedProjectContent').html('<p>Loading...</p>');
        },
        success: function (response) {
            if (response.status === 'success') {
                const projectSelect = $('#assignedProject');
                const workerSelect = $('#projectWorkers');

                if (window.Choices) {
                    if (projectSelect.data('choices')) {
                        projectSelect.data('choices').destroy();
                        projectSelect.removeData('choices');
                    }
                    if (workerSelect.data('choices')) {
                        workerSelect.data('choices').destroy();
                        workerSelect.removeData('choices');
                    }
                }

                projectSelect.empty();
                projectSelect.append(`<option value="${projectId}" selected>${response.employee_project_id.code}</option>`);

                workerSelect.empty();
                const addedWorkerIds = new Set();

                response.employee_project_id.employeeProjects.forEach(employeeProject => {
                    const employee = employeeProject.employee;
                    const fullName = `${employee.first_name} ${employee.middle_name || ''} ${employee.last_name}`.trim();

                    if (employeeProject.is_assigned) {
                        workerSelect.append(`<option value="${employee.id}" selected>${fullName}</option>`);
                        addedWorkerIds.add(employee.id);
                    } else {
                        if (!addedWorkerIds.has(employee.id)) {
                            workerSelect.append(`<option value="${employee.id}">${fullName}</option>`);
                            addedWorkerIds.add(employee.id);
                        }
                    }
                });

                const employeesArray = Object.values(response.employees_list);
                employeesArray.forEach(employee => {
                    if (!addedWorkerIds.has(employee.id)) {
                        const fullName = `${employee.first_name} ${employee.middle_name || ''} ${employee.last_name}`.trim();
                        workerSelect.append(`<option value="${employee.id}">${fullName}</option>`);
                    }
                });

                if (window.Choices) {
                    const projectChoices = new Choices('#assignedProject', {
                        searchEnabled: true,
                        removeItemButton: true,
                        allowHTML: true,
                        multiple: false
                    });
                    const workerChoices = new Choices('#projectWorkers', {
                        searchEnabled: true,
                        removeItemButton: true,
                        allowHTML: true,
                        multiple: true
                    });

                    projectSelect.data('choices', projectChoices);
                    workerSelect.data('choices', workerChoices);

                    $('.selected-project-div').show();
                    $('.selected-project-spinner').hide();
                }

                recreateCollapsibleSections(projectId, response.employee_project_id.name, response.employee_project_id.employeeProjects);
            } else {
                $('#selectedProjectContent').html('<p>Failed to load data. Please try again.</p>');
            }
        },
        error: function (xhr, status, error) {
            $('#selectedProjectContent').html('<p>Error loading data. Please try again.</p>');
            console.error('Error:', error);
        }
    });

    function recreateCollapsibleSections(projectId, projectName, employeeProjects) {
        $(`.collapsible-${projectId}`).remove();

        const collapsibleTemplate = `
            <div data-project-id="${projectId}" class="collapsible col-span-12 card collapsible-${projectId}">
                <div class="card-body flex justify-between text-white collapsible-header group/item rounded-md bg-custom-500 border-custom-500 hover:text-white hover:bg-custom-600 hover:border-custom-600 focus:text-white focus:bg-custom-600 focus:border-custom-600 focus:ring focus:ring-custom-100 active:text-white active:bg-custom-600 active:border-custom-600 active:ring active:ring-custom-100 dark:ring-custom-400/20 show">
                    <h6 class="text-15 text-white">${projectName}</h6>
                    <div class="ltr:ml-2 rtl:mr-2 shrink-0">
                        <i data-lucide="chevron-down" class="hidden size-4 group-[.show]/item:inline-block"></i>
                        <i data-lucide="chevron-up" class="inline-block size-4 group-[.show]/item:hidden"></i>
                    </div>
                </div>
                <div class="mt-2 mb-0 collapsible-content card workers-card">
                    ${employeeProjects
                        .filter(employeeProject => employeeProject.is_assigned)
                        .map(employeeProject => createWorkerCard(employeeProject, projectId, 'update'))
                        .join('')}
                </div>
            </div>
        `;

        $('.selected-dynamic-projects').append(collapsibleTemplate);

        if (window.lucide) {
            lucide.createIcons();
        }

        filterTasksByDateRange();
    }

    function createWorkerCard(employeeProject, projectId, action) {
        const employee = employeeProject.employee;
        const fullName = `${employee.first_name} ${employee.middle_name || ''} ${employee.last_name}`.trim();

        return `
            <div class="card-body worker-card" data-worker-id="${employee.id}">
                <div class="grid gap-4 grid-cols-6 flex items-start">
                    <span class="inline-block mb-2 text-base font-medium">${fullName}</span>
                    <div class="grid gap-x-4 grid-cols-12 col-span-12 md:col-span-12 border rounded-md border-dashed p-5">
                        <div class="grid gap-4 grid-cols-12 col-span-12 mb-2">
                            <div class="col-span-4">
                                <span class="inline-block mb-2 text-base font-medium">Task</span>
                            </div>
                            <div class="col-span-4">
                                <span class="inline-block mb-2 text-base font-medium">Date</span>
                            </div>
                            <div class="col-span-4">
                                <span class="inline-block mb-2 text-base font-medium">Assigned Time</span>
                            </div>
                        </div>
                        <input type="hidden" name="assignments[projects][${projectId}][workers][${employee.id}][workerId]" value="${employee.id}">
                        <input type="hidden" name="assignments[projects][${projectId}][workers][${employee.id}][projectId]" value="${projectId}">
                        <input type="hidden" name="assignments[projects][${projectId}][workers][${employee.id}][action]" value="${action}">
                        <div class="grid gap-4 grid-cols-12 col-span-12 mb-2 dependents-wrapper"></div>
                        <div class="grid gap-4 grid-cols-12 col-span-12 mb-2 add-dependent-wrapper">
                            <div class="col-span-12 flex justify-end items-center">
                                <i data-lucide="plus" class="size-4 text-custom-500"></i>
                                <a href="javascript:void(0)" class="text-custom-500 addTask underline underline-offset-5" data-worker-id="${employee.id}" data-project-id="${projectId}"> Add Task</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function createTaskContainer(workerId, projectId, taskIndex, taskName, taskDate, taskTime, taskId) {
        const formattedDate = new Date(taskDate + 'T00:00:00Z').toLocaleDateString('en-GB', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            timeZone: 'UTC'
        });

        return `
            <div class="grid gap-4 grid-cols-12 col-span-12 dependents-container">
                <div class="col-span-12 flex justify-end toggle-hidden-dependent">
                    <button type="button" class="flex items-center justify-center transition-all duration-200 ease-linear rounded size-8 text-red-500 bg-red-100 hover:bg-red-200 dark:bg-red-500/20 dark:hover:bg-red-500/30 delTask" data-worker-id="${workerId}">
                        <i data-lucide="trash" class="size-4"></i>
                    </button>
                </div>
                <input type="hidden" name="assignments[projects][${projectId}][workers][${workerId}][tasks][${taskIndex}][status]" value="update">
                <input type="hidden" name="assignments[projects][${projectId}][workers][${workerId}][tasks][${taskIndex}][task_id]" value="${taskId}">
                <div class="col-span-4">
                    <input type="text" name="assignments[projects][${projectId}][workers][${workerId}][tasks][${taskIndex}][task]" class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 placeholder:text-slate-400 dark:placeholder:text-zink-200" value="${taskName}" placeholder="Enter Task Name">
                </div>
                <div class="col-span-4">
                    <input type="text" name="assignments[projects][${projectId}][workers][${workerId}][tasks][${taskIndex}][date]" class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 placeholder:text-slate-400 dark:placeholder:text-zink-200" value="${formattedDate}" placeholder="Select date" data-provider="flatpickr" data-date-format="d M, Y" data-altFormat="d M, Y">
                </div>
                <div class="col-span-4">
                    <input type="text" name="assignments[projects][${projectId}][workers][${workerId}][tasks][${taskIndex}][time]" class="form-input border-slate-200 dark:border-zink-500 focus:outline-none focus:border-custom-500 placeholder:text-slate-400 dark:placeholder:text-zink-200" value="${taskTime}" placeholder="Enter Time (Hours:Minutes)" data-provider="timepickr" data-time-hrs="true">
                </div>
            </div>
        `;
    }

    $('#worker_log_date').flatpickr({
        mode: "range",
        dateFormat: "Y-m-d",
        onChange: function(selectedDates, dateStr, instance) {
            filterTasksByDateRange();
        }
    });

    $(document).on('click', '.delTask', function (e) {
        e.preventDefault();
        const taskContainer = $(this).closest('.dependents-container');
        taskContainer.find('input[name$="[status]"]').val('delete');
        taskContainer.hide();
    });

    function getSemiMonthlyRanges(year, month) {
        const startDate = new Date(year, month - 1, 1);
        const midDate = new Date(year, month - 1, 15);
        const secondHalfStartDate = new Date(year, month - 1, 16);
        const endDate = new Date(year, month, 0);

        const formatDate = (date) => {
            const d = date.getDate().toString().padStart(2, '0');
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const y = date.getFullYear();
            return `${y}-${m}-${d}`;
        };

        return {
            firstHalf: {
                start: formatDate(startDate),
                end: formatDate(midDate)
            },
            secondHalf: {
                start: formatDate(secondHalfStartDate),
                end: formatDate(endDate)
            }
        };
    }

    function getCurrentHalfRange() {
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1;
        const ranges = getSemiMonthlyRanges(year, month);
        const day = today.getDate();

        if (day <= 15) {
            return { half: 'firstHalf', range: ranges.firstHalf };
        } else {
            return { half: 'secondHalf', range: ranges.secondHalf };
        }
    }

    function initialize_date_start() {
        const range = getCurrentHalfRange().range;
        $('#worker_log_date').val(range.start + ' to ' + range.end);
    }

    initialize_date_start();

    function filterTasksByDateRange() {
        const value = $('#worker_log_date').val();
        if (!value) return;

        const dateRange = value.split(' to ');
        const projectId = $('#assignedProject').val();

        const startDate = dateRange[0] || null;
        const endDate = dateRange[1] || dateRange[0] || null;

        if (!startDate) {
            console.error('Start date is missing.');
            return;
        }

        const promises = [];

        $('.worker-card').each(function () {
            const workerId = $(this).data('worker-id');
            const dependentsWrapper = $(this).find('.dependents-wrapper');
            dependentsWrapper.html('');

            const jsonObject = {
                start_date: startDate,
                end_date: endDate,
                project_id: projectId,
                employee_id: workerId
            };

            const promise = apiCall('POST', 'api/employee-projects/filter', jsonObject)
                .then(response => {
                    if (response && response.tasks && response.tasks.length > 0) {
                        let tasksHtml = '';

                        response.tasks.forEach((task, index) => {
                            if (!task.archived) {
                                const totalMinutes = task.assigned_hours;
                                const hours = Math.floor(totalMinutes / 60);
                                const minutes = totalMinutes % 60;
                                const time = `${hours}:${minutes.toString().padStart(2, '0')}`;

                                tasksHtml += createTaskContainer(
                                    workerId,
                                    projectId,
                                    index,
                                    task.task_desc,
                                    task.date,
                                    time,
                                    task.id
                                );
                            }
                        });

                        dependentsWrapper.html(tasksHtml);

                        if (window.lucide) {
                            lucide.createIcons();
                        }

                        if (typeof reinitializeFlatpickr === 'function') {
                            reinitializeFlatpickr();
                        }
                        if (typeof reinitializeTimepickr === 'function') {
                            reinitializeTimepickr();
                        }
                    }
                })
                .catch(error => {
                    console.error(`Error fetching tasks for worker ${workerId}:`, error);
                });

            promises.push(promise);
        });

        Promise.all(promises)
            .then(() => {
                console.log('All tasks have been loaded.');
            })
            .catch(error => {
                console.error('Error loading tasks:', error);
            });
    }
});

function resetModal(modalId) {
    const modal = $(`#${modalId}`);

    modal.find('.collapsible').remove();

    modal.find('input, select').each(function () {
        if ($(this).is('select')) {
            if ($(this).data('choices')) {
                $(this).data('choices').destroy();
                $(this).removeData('choices');
            }
            $(this).empty();
        } else if ($(this).is('input[type="text"]')) {
            $(this).val('');
        }
    });

    modal.find('#alert-error-msg').addClass('hidden').text('');
    modal.addClass('hidden').removeClass('flex');
}

function unselectChoices(){
    const projectSelect = $('#projectSelect');
    if (projectSelect.data('choices')) {
        projectSelect.data('choices').removeActiveItems();
    }

    const workerSelect = $('#workerSelect');
    if (workerSelect.data('choices')) {
        workerSelect.data('choices').removeActiveItems();
    }
}

function clearCollapsiblesInModal(modalId) {
    const modal = $(`#${modalId}`);
    modal.find('.collapsible').remove();
}

$(document).on('click', '.close-modal-assign-workers', function () {
    const modalId = $(this).data('modal-close');
    clearCollapsiblesInModal(modalId);
    unselectChoices();
});

$(document).on('submit', '#selectedProjectForm', function (e) {
    e.preventDefault();
    const formData = $(this).serialize();

    $.ajax({
        url: '{{ path("update_selected_project_workers") }}',
        type: 'POST',
        data: formData,
        beforeSend: function () {
            $('#updateSelectedProject').prop('disabled', true).text('Submitting...');
        },
        success: function (response) {
            if (response.status === 'success') {
                showToast(response.message, 'bg-green-500');
            } else {
                showToast('Something went wrong!', 'bg-red-500');
            }
        },
        error: function (xhr, status, error) {
            console.error('Error:', error);
            showToast('Failed to submit data. Please try again.', 'bg-red-500');
        },
        complete: function () {
            $('#updateSelectedProject').prop('disabled', false).text('Save');
        }
    });
});

$(document).on('click', '.close-modal-selectedProject', function () {
    const modalId = $(this).data('modal-close');
    clearCollapsiblesInModal(modalId);
    resetModal(modalId);
});
</script>
{% endblock %}
